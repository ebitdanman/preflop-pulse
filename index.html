<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Pre-Flop Pulse">
<meta name="theme-color" content="#f5f0e8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>Pre-Flop Pulse</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@500;600;700&family=Nunito:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: #f5f0e8;
    font-family: 'Nunito', sans-serif;
    min-height: 100vh;
    min-height: 100dvh;
    position: relative;
    overflow: hidden;
    -webkit-text-size-adjust: 100%;
  }


  .app-screen {
    position: fixed;
    inset: 0;
    padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 20px);
    padding-top: calc(env(safe-area-inset-top, 20px) + 12px);
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateX(30px);
    overflow-y: auto;
    background: #f5f0e8;
  }
  .app-screen.active { opacity: 1; pointer-events: all; transform: translateX(0); }
  .app-screen::-webkit-scrollbar { width: 0; }


  :root {
    --felt: #2d6b45;
    --felt-dark: #1e4d32;
    --felt-light: #3a8a5a;
    --burgundy: #8b2d3a;
    --burgundy-dark: #6e1f2c;
    --gold: #c5a55a;
    --gold-light: #dbc278;
    --cream: #f5f0e8;
    --cream-dark: #e8dfd2;
    --leather: #5c3d2e;
    --text-dark: #2a2017;
    --text-mid: #6b5c4c;
    --text-light: #9a8b78;
    --card-bg: #fffdf8;
    --border: #ddd4c4;
  }

  /* SCREEN 1: SETUP */
  .setup-screen .logo-area { text-align: center; margin-top: 36px; margin-bottom: 36px; }

  .logo-area .felt-badge {
    width: 72px; height: 72px;
    background: var(--felt);
    border-radius: 50%;
    margin: 0 auto 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    box-shadow: 0 4px 12px rgba(45,107,69,0.3), inset 0 2px 4px rgba(255,255,255,0.15);
  }

  .logo-area h1 {
    font-family: 'Lora', serif;
    font-size: 26px; font-weight: 700;
    color: var(--text-dark);
  }

  .logo-area .subtitle {
    font-size: 13px; color: var(--text-light);
    font-family: 'DM Mono', monospace;
    margin-top: 4px;
  }

  .setup-section { margin-bottom: 28px; }

  .section-label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-light); text-transform: uppercase;
    letter-spacing: 1.5px; margin-bottom: 12px;
    font-family: 'DM Mono', monospace;
  }

  .table-size-options { display: flex; gap: 10px; }

  .table-size-btn {
    flex: 1; padding: 18px 0;
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 14px;
    color: var(--text-mid);
    font-size: 22px; font-weight: 600;
    font-family: 'Lora', serif;
    cursor: pointer; transition: all 0.2s;
    text-align: center;
  }

  .table-size-btn span {
    display: block; font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--text-light); margin-top: 4px; font-weight: 400;
  }

  .table-size-btn.selected {
    background: var(--felt); border-color: var(--felt); color: #fff;
    box-shadow: 0 4px 16px rgba(45,107,69,0.25);
  }
  .table-size-btn.selected span { color: rgba(255,255,255,0.7); }

  .start-btn {
    width: 100%; padding: 18px;
    background: var(--burgundy); border: none; border-radius: 14px;
    color: #fff; font-size: 16px; font-weight: 600;
    font-family: 'Nunito', sans-serif;
    cursor: pointer; margin-top: auto; margin-bottom: 10px;
    transition: all 0.2s; letter-spacing: 0.3px;
    box-shadow: 0 4px 16px rgba(139,45,58,0.3);
  }
  .start-btn:hover { background: var(--burgundy-dark); }
  .start-btn:active { transform: scale(0.98); }

  .position-pills { display: flex; gap: 6px; flex-wrap: wrap; }

  .pos-pill {
    padding: 8px 11px;
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text-mid);
    font-size: 11px; font-weight: 600;
    font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s;
  }

  .pos-pill.active {
    background: var(--felt); border-color: var(--felt); color: #fff;
    box-shadow: 0 2px 8px rgba(45,107,69,0.25);
  }
  .pos-pill:hover:not(.active) { border-color: var(--text-light); }

  /* SCREEN 2: MAIN */
  .main-screen {
    padding-top: calc(env(safe-area-inset-top, 20px) + 12px) !important;
    padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 10px) !important;
    gap: 12px;
  }

  .top-bar { display: flex; justify-content: space-between; align-items: center; }

  .hand-counter { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-light); }
  .hand-counter strong {
    color: var(--felt-dark); font-size: 18px;
    font-family: 'Lora', serif;
  }

  .export-btn {
    padding: 8px 14px; background: transparent;
    border: 1.5px solid var(--border); border-radius: 10px;
    color: var(--text-mid); font-size: 11px;
    font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.2s;
  }
  .export-btn:hover { border-color: var(--burgundy); color: var(--burgundy); }

  .panel {
    background: var(--card-bg); border-radius: 14px;
    padding: 14px; border: 1.5px solid var(--border);
  }

  .panel .strip-label {
    font-size: 10px; color: var(--text-light);
    font-family: 'DM Mono', monospace;
    text-transform: uppercase; letter-spacing: 1.2px;
    margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
  }

  .selected-hand {
    font-size: 16px; color: var(--burgundy);
    font-weight: 700; font-family: 'Lora', serif;
    letter-spacing: 0; text-transform: none;
  }

  .card-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 5px; margin-bottom: 10px;
  }

  .card-btn {
    aspect-ratio: 1;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text-dark);
    font-size: 15px; font-weight: 600;
    font-family: 'Lora', serif;
    cursor: pointer; transition: all 0.12s;
    display: flex; align-items: center; justify-content: center;
  }
  .card-btn:hover { border-color: var(--text-light); }
  .card-btn.selected {
    background: var(--felt); border-color: var(--felt); color: #fff;
    box-shadow: 0 2px 8px rgba(45,107,69,0.2);
  }

  .suit-toggle { display: flex; gap: 8px; }

  .suit-btn {
    flex: 1; padding: 10px;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    color: var(--text-mid);
    font-size: 13px; font-weight: 500;
    font-family: 'DM Mono', monospace;
    cursor: pointer; text-align: center; transition: all 0.15s;
  }
  .suit-btn.active { background: var(--felt); border-color: var(--felt); color: #fff; }
  .suit-btn.pair-lock { opacity: 0.3; pointer-events: none; }

  .action-btns { display: flex; gap: 6px; flex-wrap: wrap; }

  .action-btn {
    padding: 10px 14px;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    color: var(--text-mid);
    font-size: 12px; font-weight: 600;
    font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s;
  }
  .action-btn:hover { border-color: var(--text-light); }
  .action-btn.selected { background: var(--felt); border-color: var(--felt); color: #fff; }

  .hero-action-btns .action-btn.fold-btn.selected { background: var(--burgundy); border-color: var(--burgundy); color: #fff; }
  .hero-action-btns .action-btn.call-btn.selected { background: #3a6b8a; border-color: #3a6b8a; color: #fff; }
  .hero-action-btns .action-btn.raise-btn.selected { background: var(--felt); border-color: var(--felt); color: #fff; }
  /* Amount input */
  .amount-control {
    margin-top: 10px; display: none;
    padding-top: 10px;
    border-top: 1px dashed var(--border);
    align-items: center; gap: 10px;
  }
  .amount-control.show { display: flex; }
  .amount-control span {
    font-size: 11px; color: var(--text-light);
    font-family: 'DM Mono', monospace; white-space: nowrap;
  }
  .amount-input-wrap {
    display: flex; align-items: center;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 10px; overflow: hidden;
    flex: 1;
  }
  .amount-input-wrap .dollar {
    padding: 0 0 0 12px;
    font-size: 15px; font-weight: 600;
    color: var(--text-mid);
    font-family: 'DM Mono', monospace;
  }
  .amount-input-wrap input {
    width: 100%; padding: 10px 12px 10px 4px;
    background: transparent; border: none; outline: none;
    font-size: 15px; font-weight: 600;
    color: var(--felt-dark);
    font-family: 'DM Mono', monospace;
  }
  .amount-input-wrap input::placeholder { color: var(--text-light); font-weight: 400; }
  .amount-chips { display: flex; gap: 5px; margin-top: 8px; }
  .amount-chip {
    padding: 5px 10px;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 7px;
    color: var(--text-mid);
    font-size: 10px; font-weight: 600;
    font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s;
  }
  .amount-chip:hover { border-color: var(--text-light); }
  .amount-chip.active { background: var(--felt); border-color: var(--felt); color: #fff; }

  .who-acted {
    margin-top: 10px; display: none;
    padding-top: 10px;
    border-top: 1px dashed var(--border);
  }
  .who-acted.show { display: block; }

  .who-acted .who-label {
    font-size: 10px; color: var(--text-light);
    font-family: 'DM Mono', monospace;
    margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
  }

  .who-pills { display: flex; gap: 5px; flex-wrap: wrap; }

  .who-pill {
    padding: 6px 10px;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 7px;
    color: var(--text-mid);
    font-size: 10px; font-weight: 600;
    font-family: 'DM Mono', monospace;
    cursor: pointer; transition: all 0.15s;
  }
  .who-pill:hover { border-color: var(--text-light); }
  .who-pill.active { background: var(--leather); border-color: var(--leather); color: #fff; }

  .limper-control {
    display: none; align-items: center; gap: 10px;
    margin-top: 10px; padding-top: 10px;
    border-top: 1px dashed var(--border);
  }
  .limper-control.show { display: flex; }

  .limper-control span { font-size: 11px; color: var(--text-light); font-family: 'DM Mono', monospace; }

  .limper-stepper {
    display: flex; align-items: center;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: 10px; overflow: hidden;
  }
  .limper-stepper button {
    width: 36px; height: 36px; background: transparent;
    border: none; color: var(--text-mid); font-size: 16px;
    cursor: pointer; font-family: 'DM Mono', monospace;
  }
  .limper-stepper button:hover { color: var(--felt-dark); }
  .limper-stepper .count {
    width: 30px; text-align: center; font-size: 14px;
    color: var(--felt-dark); font-family: 'Lora', serif; font-weight: 700;
  }

  .save-hand-btn {
    width: 100%; padding: 16px;
    background: var(--burgundy); border: none; border-radius: 14px;
    color: #fff; font-size: 15px; font-weight: 600;
    font-family: 'Nunito', sans-serif;
    cursor: pointer; transition: all 0.2s;
    flex-shrink: 0;
    box-shadow: 0 4px 16px rgba(139,45,58,0.2);
  }
  .save-hand-btn:hover { background: var(--burgundy-dark); }
  .save-hand-btn:active { transform: scale(0.97); }

  .toast {
    position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 80px);
    left: 20px; right: 20px;
    background: var(--felt); border-radius: 14px;
    padding: 16px 20px; display: flex; align-items: center; gap: 12px;
    z-index: 200; opacity: 0; transform: translateY(20px);
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    box-shadow: 0 8px 24px rgba(45,107,69,0.35);
  }
  .toast.show { opacity: 1; transform: translateY(0); pointer-events: all; }
  .toast .check {
    width: 28px; height: 28px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-weight: 700; font-size: 14px; flex-shrink: 0;
  }
  .toast .toast-text { font-size: 13px; color: rgba(255,255,255,0.85); }
  .toast .toast-text strong { color: #fff; display: block; margin-bottom: 2px; }

  /* SCREEN 3: EXPORT */
  .export-screen {
    padding-top: calc(env(safe-area-inset-top, 20px) + 12px) !important;
  }

  .export-screen .back-btn {
    display: flex; align-items: center; gap: 6px;
    background: none; border: none;
    color: var(--burgundy);
    font-family: 'DM Mono', monospace;
    font-size: 13px; cursor: pointer;
    margin-bottom: 28px; padding: 0; font-weight: 500;
  }

  .export-screen h2 {
    font-family: 'Lora', serif;
    font-size: 22px; font-weight: 600;
    color: var(--text-dark); margin-bottom: 6px;
  }

  .export-screen .session-stats {
    font-family: 'DM Mono', monospace;
    font-size: 12px; color: var(--text-light); margin-bottom: 28px;
  }

  .csv-preview {
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    border-radius: 14px; padding: 16px;
    margin-bottom: 20px; overflow-x: auto;
  }

  .csv-preview table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 10px; }
  .csv-preview th { text-align: left; color: var(--text-light); padding: 6px 8px; border-bottom: 1.5px solid var(--border); white-space: nowrap; font-weight: 500; }
  .csv-preview td { color: var(--text-dark); padding: 8px 8px; border-bottom: 1px solid var(--cream-dark); white-space: nowrap; }
  .csv-preview td.fold-cell { color: var(--burgundy); }
  .csv-preview td.raise-cell { color: var(--felt-dark); }
  .csv-preview td.call-cell { color: #3a6b8a; }

  .share-options { display: flex; flex-direction: column; gap: 10px; }

  .share-btn {
    width: 100%; padding: 16px; border-radius: 14px;
    font-size: 14px; font-weight: 600;
    font-family: 'Nunito', sans-serif;
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .share-btn.primary { background: var(--burgundy); border: none; color: #fff; box-shadow: 0 4px 16px rgba(139,45,58,0.2); }
  .share-btn.secondary { background: transparent; border: 1.5px solid var(--border); color: var(--text-mid); }
  .share-btn:hover { transform: scale(0.98); }

  .share-btn.danger {
    background: transparent; border: 1.5px solid var(--burgundy);
    color: var(--burgundy);
  }

  .share-btn .btn-feedback {
    font-size: 12px; opacity: 0.85;
  }

  /* Confirm overlay */
  .confirm-overlay {
    position: fixed; inset: 0;
    background: rgba(42,32,23,0.5);
    display: none; align-items: center; justify-content: center;
    z-index: 300; padding: 30px;
    border-radius: 0;
  }
  .confirm-overlay.show { display: flex; }

  .confirm-box {
    background: var(--card-bg);
    border-radius: 18px;
    padding: 28px 24px;
    text-align: center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    width: 100%;
  }
  .confirm-icon { font-size: 32px; margin-bottom: 12px; }
  .confirm-title {
    font-family: 'Lora', serif;
    font-size: 18px; font-weight: 700;
    color: var(--text-dark); margin-bottom: 8px;
  }
  .confirm-text {
    font-size: 13px; color: var(--text-mid);
    line-height: 1.5; margin-bottom: 22px;
  }
  .confirm-btns { display: flex; gap: 10px; }
  .confirm-cancel {
    flex: 1; padding: 14px;
    background: var(--cream); border: 1.5px solid var(--border);
    border-radius: 12px; color: var(--text-mid);
    font-size: 14px; font-weight: 600;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }
  .confirm-delete {
    flex: 1; padding: 14px;
    background: var(--burgundy); border: none;
    border-radius: 12px; color: #fff;
    font-size: 14px; font-weight: 600;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }

  .felt-header {
    background: var(--felt);
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(255,255,255,0.05) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 50%, rgba(0,0,0,0.1) 0%, transparent 50%);
    margin: -14px -14px 14px -14px;
    padding: 12px 14px;
    border-radius: 12px 12px 0 0;
  }
  .felt-header .strip-label { color: rgba(255,255,255,0.7) !important; margin-bottom: 0 !important; }
  .felt-header .selected-hand { color: var(--gold-light) !important; }
</style>
</head>
<body>
    <!-- SETUP -->
    <div class="app-screen setup-screen active" id="screen-setup">
      <div class="logo-area">
        <div class="felt-badge">üÉè</div>
        <h1>Pre-Flop Pulse</h1>
        <div class="subtitle">session logger v1</div>
      </div>
      <div class="setup-section">
        <label class="section-label">Table Size</label>
        <div class="table-size-options">
          <button class="table-size-btn" data-size="6" onclick="selectTableSize(this)">6<span>max</span></button>
          <button class="table-size-btn selected" data-size="8" onclick="selectTableSize(this)">8<span>max</span></button>
          <button class="table-size-btn" data-size="9" onclick="selectTableSize(this)">9<span>max</span></button>
        </div>
      </div>
      <div class="setup-section">
        <label class="section-label">Starting Position</label>
        <div class="position-pills" id="setup-positions"></div>
      </div>
      <button class="start-btn" onclick="startSession()">Deal Me In</button>
    </div>

    <!-- HAND ENTRY -->
    <div class="app-screen main-screen" id="screen-main">
      <div class="top-bar">
        <div class="hand-counter">Hand <strong id="hand-num">1</strong></div>
        <button class="export-btn" onclick="showExport()">Export CSV ‚Üí</button>
      </div>
      <div class="panel">
        <div class="strip-label">Hero Position</div>
        <div class="position-pills" id="main-positions"></div>
      </div>
      <div class="panel">
        <div class="felt-header">
          <div class="strip-label">Hole Cards <span class="selected-hand" id="hand-display">‚Äî</span></div>
        </div>
        <div class="card-grid" id="card-grid"></div>
        <div class="suit-toggle">
          <button class="suit-btn" id="suited-btn" onclick="setSuit('s')">Suited</button>
          <button class="suit-btn" id="offsuit-btn" onclick="setSuit('o')">Offsuit</button>
        </div>
      </div>
      <div class="panel">
        <div class="strip-label">Action Facing Hero</div>
        <div class="action-btns">
          <button class="action-btn" onclick="selectFacing(this, 'Open')">Open</button>
          <button class="action-btn" onclick="selectFacing(this, 'Limpers')">Limpers</button>
          <button class="action-btn" onclick="selectFacing(this, '3-Bet')">3-Bet</button>
          <button class="action-btn" onclick="selectFacing(this, '4-Bet+')">4-Bet+</button>
        </div>
        <div class="who-acted" id="who-acted">
          <div class="who-label">By whom?</div>
          <div class="who-pills" id="who-pills"></div>
        </div>
        <div class="limper-control" id="limper-control">
          <span># Limpers</span>
          <div class="limper-stepper">
            <button onclick="adjustLimpers(-1)">‚àí</button>
            <div class="count" id="limper-count">1</div>
            <button onclick="adjustLimpers(1)">+</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="strip-label">Hero Action</div>
        <div class="action-btns hero-action-btns">
          <button class="action-btn fold-btn" onclick="selectHero(this, 'Fold')">Fold</button>
          <button class="action-btn call-btn" onclick="selectHero(this, 'Call')">Call</button>
          <button class="action-btn raise-btn" onclick="selectHero(this, 'Raise')">Raise</button>
        </div>
        <div class="amount-control" id="amount-control">
          <span>Amount</span>
          <div class="amount-input-wrap">
            <span class="dollar">$</span>
            <input type="number" id="hero-amount" placeholder="0" inputmode="numeric">
          </div>
        </div>
        <div class="amount-chips" id="amount-chips" style="display:none;">
          <button class="amount-chip" onclick="setAmount(10)">$10</button>
          <button class="amount-chip" onclick="setAmount(15)">$15</button>
          <button class="amount-chip" onclick="setAmount(25)">$25</button>
          <button class="amount-chip" onclick="setAmount(50)">$50</button>
          <button class="amount-chip" onclick="setAmount(100)">$100</button>
        </div>
      </div>
      <button class="save-hand-btn" onclick="saveHand()">Save Hand</button>
      <div class="toast" id="toast">
        <div class="check">‚úì</div>
        <div class="toast-text">
          <strong>Hand Saved</strong>
          <span id="toast-detail">Position auto-advanced</span>
        </div>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="app-screen export-screen" id="screen-export">
      <button class="back-btn" onclick="showMain()">‚Üê Back</button>
      <h2>Session Export</h2>
      <div class="session-stats" id="session-stats">0 hands ¬∑ 8-max ¬∑ 0m</div>
      <div class="csv-preview">
        <table>
          <thead><tr><th>Time</th><th>Pos</th><th>Cards</th><th>Facing</th><th>By</th><th>Action</th><th>Amt</th></tr></thead>
          <tbody id="csv-body"></tbody>
        </table>
      </div>
      <div class="share-options">
        <button class="share-btn primary" onclick="copyToClipboard()">Copy to Clipboard</button>
        <button class="share-btn secondary" onclick="downloadCSV()">Download CSV</button>
        <button class="share-btn danger" id="clear-btn" onclick="clearSession()">Clear Session</button>
      </div>

      <!-- Confirm overlay -->
      <div class="confirm-overlay" id="confirm-overlay">
        <div class="confirm-box">
          <div class="confirm-icon">‚ö†Ô∏è</div>
          <div class="confirm-title">Clear all hands?</div>
          <div class="confirm-text">Make sure you've copied or downloaded your data first. This can't be undone.</div>
          <div class="confirm-btns">
            <button class="confirm-cancel" onclick="hideConfirm()">Cancel</button>
            <button class="confirm-delete" onclick="confirmClear()">Clear</button>
          </div>
        </div>
      </div>
<script>
  const positions6 = ['SB','BB','UTG','MP','CO','BTN'];
  const positions8 = ['SB','BB','UTG','UTG+1','MP','HJ','CO','BTN'];
  const positions9 = ['SB','BB','UTG','UTG+1','MP','MP+1','HJ','CO','BTN'];
  const ranks = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];

  let tableSize = 8, currentPositions = positions8, posIndex = 0, handNum = 1;
  let selectedCards = [], suitedness = null, facingAction = null, facingWho = null;
  let heroAction = null, heroAmount = null, limperCount = 1, savedHands = [], sessionStart = null;

  function init() { renderSetupPositions(); buildCardGrid(); }

  function getPositions(s) { return s === 6 ? positions6 : s === 8 ? positions8 : positions9; }

  function selectTableSize(btn) {
    document.querySelectorAll('.table-size-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    tableSize = parseInt(btn.dataset.size);
    currentPositions = getPositions(tableSize);
    posIndex = 0;
    renderSetupPositions();
  }

  function renderSetupPositions() {
    document.getElementById('setup-positions').innerHTML = currentPositions.map((p, i) =>
      `<button class="pos-pill ${i === posIndex ? 'active' : ''}" onclick="posIndex=${i};renderSetupPositions()">${p}</button>`
    ).join('');
  }

  function renderMainPositions() {
    document.getElementById('main-positions').innerHTML = currentPositions.map((p, i) =>
      `<button class="pos-pill ${i === posIndex ? 'active' : ''}" onclick="posIndex=${i};renderMainPositions()">${p}</button>`
    ).join('');
  }

  function renderWhoPills() {
    const heroPos = currentPositions[posIndex];
    const others = currentPositions.filter(p => p !== heroPos);
    document.getElementById('who-pills').innerHTML = others.map(p =>
      `<button class="who-pill ${facingWho === p ? 'active' : ''}" onclick="selectWho('${p}')">${p}</button>`
    ).join('');
  }

  function selectWho(pos) {
    facingWho = pos;
    document.querySelectorAll('.who-pill').forEach(b => {
      b.classList.toggle('active', b.textContent === pos);
    });
  }

  function buildCardGrid() {
    document.getElementById('card-grid').innerHTML = ranks.map(r =>
      `<button class="card-btn" data-rank="${r}" onclick="selectCard(this)">${r}</button>`
    ).join('');
  }

  function showScreen(id) {
    document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function startSession() {
    sessionStart = new Date();
    currentPositions = getPositions(tableSize);
    renderMainPositions();
    showScreen('screen-main');
  }

  function showExport() { renderExport(); showScreen('screen-export'); }
  function showMain() { showScreen('screen-main'); }

  function selectCard(btn) {
    const rank = btn.dataset.rank;
    if (selectedCards.length < 2) {
      selectedCards.push(rank);
      btn.classList.add('selected');
    } else {
      document.querySelectorAll('.card-btn').forEach(b => b.classList.remove('selected'));
      selectedCards = [rank];
      btn.classList.add('selected');
      suitedness = null;
      document.querySelectorAll('.suit-btn').forEach(b => b.classList.remove('active'));
    }
    updateHandDisplay();
    updateSuitToggle();
  }

  function updateSuitToggle() {
    const s = document.getElementById('suited-btn'), o = document.getElementById('offsuit-btn');
    s.classList.remove('pair-lock'); o.classList.remove('pair-lock');
    if (selectedCards.length === 2 && selectedCards[0] === selectedCards[1]) {
      s.classList.add('pair-lock'); o.classList.add('pair-lock'); suitedness = null;
    }
  }

  function setSuit(s) {
    if (selectedCards.length === 2 && selectedCards[0] === selectedCards[1]) return;
    suitedness = s;
    document.querySelectorAll('.suit-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(s === 's' ? 'suited-btn' : 'offsuit-btn').classList.add('active');
    updateHandDisplay();
  }

  function updateHandDisplay() {
    const d = document.getElementById('hand-display');
    if (!selectedCards.length) { d.textContent = '‚Äî'; return; }
    if (selectedCards.length === 1) { d.textContent = selectedCards[0] + '?'; return; }
    let txt = selectedCards[0] + selectedCards[1];
    if (selectedCards[0] !== selectedCards[1] && suitedness) txt += suitedness;
    d.textContent = txt;
  }

  function selectFacing(btn, action) {
    btn.parentElement.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    facingAction = action; facingWho = null;
    document.getElementById('limper-control').classList.remove('show');
    document.getElementById('who-acted').classList.remove('show');
    if (action === 'Open' || action === '3-Bet') { renderWhoPills(); document.getElementById('who-acted').classList.add('show'); }
    else if (action === 'Limpers') { document.getElementById('limper-control').classList.add('show'); }
  }

  function selectHero(btn, action) {
    btn.parentElement.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    heroAction = action;
    heroAmount = null;
    const ac = document.getElementById('amount-control');
    const chips = document.getElementById('amount-chips');
    document.getElementById('hero-amount').value = '';
    document.querySelectorAll('.amount-chip').forEach(b => b.classList.remove('active'));
    if (action === 'Call' || action === 'Raise') {
      ac.classList.add('show');
      chips.style.display = 'flex';
    } else {
      ac.classList.remove('show');
      chips.style.display = 'none';
    }
  }

  function setAmount(val) {
    heroAmount = val;
    document.getElementById('hero-amount').value = val;
    document.querySelectorAll('.amount-chip').forEach(b => {
      b.classList.toggle('active', parseInt(b.textContent.replace('$','')) === val);
    });
  }

  function adjustLimpers(d) {
    limperCount = Math.max(1, Math.min(5, limperCount + d));
    document.getElementById('limper-count').textContent = limperCount;
  }

  function saveHand() {
    if (selectedCards.length < 2 || !facingAction || !heroAction) return;
    let cards = selectedCards[0] + selectedCards[1];
    if (selectedCards[0] !== selectedCards[1] && suitedness) cards += suitedness;
    let facing = facingAction;
    if (facingAction === 'Limpers') facing = limperCount + ' Limper' + (limperCount > 1 ? 's' : '');
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    const amtVal = document.getElementById('hero-amount').value;
    const amount = (heroAction === 'Call' || heroAction === 'Raise') && amtVal ? '$' + amtVal : '‚Äî';
    savedHands.push({ time, tableSize, position: currentPositions[posIndex], cards, facing, facingWho: facingWho || '‚Äî', heroAction, amount });
    handNum++;
    document.getElementById('hand-num').textContent = handNum;
    posIndex = (posIndex + 1) % currentPositions.length;
    renderMainPositions();

    selectedCards = []; suitedness = null; facingAction = null; facingWho = null;
    heroAction = null; heroAmount = null; limperCount = 1;
    document.querySelectorAll('.card-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.suit-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('limper-control').classList.remove('show');
    document.getElementById('who-acted').classList.remove('show');
    document.getElementById('amount-control').classList.remove('show');
    document.getElementById('amount-chips').style.display = 'none';
    document.getElementById('hero-amount').value = '';
    document.querySelectorAll('.amount-chip').forEach(b => b.classList.remove('active'));
    document.getElementById('limper-count').textContent = '1';
    document.getElementById('hand-display').textContent = '‚Äî';

    const toast = document.getElementById('toast');
    document.getElementById('toast-detail').textContent = `‚Üí ${currentPositions[posIndex]} ¬∑ ${savedHands.length} logged`;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2200);
  }

  function renderExport() {
    const elapsed = sessionStart ? Math.round((Date.now() - sessionStart) / 60000) : 0;
    document.getElementById('session-stats').textContent = `${savedHands.length} hands ¬∑ ${tableSize}-max ¬∑ ${elapsed}m`;
    document.getElementById('csv-body').innerHTML = savedHands.slice(-6).map(h => {
      const cls = h.heroAction === 'Fold' ? 'fold-cell' : h.heroAction === 'Raise' ? 'raise-cell' : h.heroAction === 'Call' ? 'call-cell' : '';
      return `<tr><td>${h.time}</td><td>${h.position}</td><td>${h.cards}</td><td>${h.facing}</td><td>${h.facingWho}</td><td class="${cls}">${h.heroAction}</td><td>${h.amount}</td></tr>`;
    }).join('');
  }

  function buildCSV() {
    const header = 'Timestamp,Table Size,Hero Position,Hole Cards,Facing Action,Facing By,Hero Action,Amount';
    const rows = savedHands.map(h =>
      `${h.time},${h.tableSize},${h.position},${h.cards},${h.facing},${h.facingWho},${h.heroAction},${h.amount}`
    );
    return [header, ...rows].join('\n');
  }

  function copyToClipboard() {
    const csv = buildCSV();
    const btn = document.querySelector('.share-btn.primary');
    navigator.clipboard.writeText(csv).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
    }).catch(() => {
      // Fallback for iOS
      const ta = document.createElement('textarea');
      ta.value = csv; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
    });
  }

  function downloadCSV() {
    const csv = buildCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `preflop-session-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function clearSession() {
    if (savedHands.length === 0) return;
    document.getElementById('confirm-overlay').classList.add('show');
  }

  function hideConfirm() {
    document.getElementById('confirm-overlay').classList.remove('show');
  }

  function confirmClear() {
    savedHands = [];
    handNum = 1;
    posIndex = 0;
    sessionStart = null;
    selectedCards = [];
    suitedness = null;
    facingAction = null;
    facingWho = null;
    heroAction = null;
    heroAmount = null;
    limperCount = 1;
    hideConfirm();
    showScreen('screen-setup');
  }
  init();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>
</html>
